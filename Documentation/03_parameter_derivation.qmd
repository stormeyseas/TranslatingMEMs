---
title: "Step 3: Parameter Derivation and Conversion"
subtitle: "Translation of Dahood et al. (2019) EwE Model"
author: 
  - "Tormey E. Reimer"
  - "Claude Sonnet 4.5"
date: last-modified
bibliography: references.bib
---

[← Previous: Model Structure](02_model_structure.qmd)

```{r}
#| label: setup
#| include: false
#| code-summary: "Load packages and set plot themes"

library(tidyverse)
library(ggplot2)
library(patchwork)
library(knitr)
library(viridis)
library(igraph)
library(ggrepel)

# Source documentation helper functions
source("doc_functions.R")

# Set theme for all plots
theme_set(theme_bw(base_size = 11))

# Color palette for species categories
category_colors <- c(
  "fish" = "#4DAF4A",
  "krill" = "#E41A1C",
  "seal" = "#377EB8",
  "whale" = "#984EA3",
  "penguin" = "#FF7F00",
  "bird" = "#FFFF33",
  "other" = "#A65628"
)
```

```{r}
#| label: source-scripts
#| code-summary: "Source R script for parameter derivation"
#| output: false

# Run parameter derivation script
source_model_script("01_derive_species_parameters.R")
```

# Overview

This document details the derivation and conversion of parameters from the @dahood2019 Ecopath with Ecosim (EwE) model to the mizer framework, and provides a comprehensive assessment of the resulting parameters. The translation requires careful conversion of EwE's biomass-pool parameters to mizer's size-spectrum parameters while preserving the key ecological relationships and calibration targets.

## Key Parameterization Decisions

Based on the model structure designed in [Step 2](02_model_structure.qmd), the following parameterization approach was adopted:

1. **Marine mammals and seabirds**: Adult-only representation with narrow size ranges
2. **Fish and cephalopods**: Full size-structured representation from recruitment to maximum size
3. **Euphausiids**: Complete size structure from juveniles to adults
4. **Parameter sources**: Detailed literature review for 8 monitored species, representative values for others
5. **Consumption rates**: Calibrated to match EwE Q/B ratios

# Mizer Parameter Requirements

The mizer model requires the following parameters for each species:

## Essential Size Parameters

- **`w_min`**: Minimum size (g) - typically recruitment size
- **`w_mat`**: Size at maturity (g) - size at which 50% are mature
- **`w_inf`**: Asymptotic maximum size (g) - von Bertalanffy $L_\infty$ converted to mass

## Growth Parameters

- **`k_vb`**: von Bertalanffy growth parameter (year$^{-1}$)
- **`h`**: Maximum consumption rate coefficient
- **`ks`**: Standard metabolism coefficient (typically set equal to `h`)

## Mortality Parameters

- **`z0`**: Background mortality rate (year$^{-1}$) - size-independent mortality

## Feeding Parameters

- **`beta`**: Preferred predator-prey mass ratio (PPMR)
- **`sigma`**: Width of feeding kernel (log scale)
- **Interaction matrix**: Species-specific prey preferences

## Reproductive Parameters

- **`erepro`**: Reproductive efficiency - proportion of consumed energy allocated to reproduction
- **`R_max`**: Maximum recruitment (optional, can be calculated from steady-state)

# Parameter Derivation Methodology

## 1. Size Parameters

### Fish and Cephalopods

For fish species, size parameters were derived from Antarctic fish literature [@kock1992; @hill2007]:

**Notothenia rossii** (Marbled rockcod):

- `w_min` = 50 g: Recruitment size
- `w_mat` = 2,000 g: Mature at 35-55 cm total length
- `w_inf` = 7,000 g: Maximum size ~70 cm

**Champsocephalus gunnari** (Mackerel icefish):

- `w_min` = 50 g: Recruitment size
- `w_mat` = 300 g: Mature at 24-28 cm
- `w_inf` = 500 g: Maximum size ~50 cm

**Gobionotothen gibberifrons** (Humped rockcod):

- `w_min` = 50 g: Recruitment size
- `w_mat` = 150 g: Mature at 15-18 cm
- `w_inf` = 400 g: Maximum size ~30 cm

**Cephalopods**:

- `w_min` = 100 g: Recruitment to population
- `w_mat` = 2,000 g: Average maturity for squid
- `w_inf` = 5,000 g: Large squid species (50-100 cm mantle length)

**Myctophids** (Lanternfishes):

- `w_min` = 1 g: Small mesopelagic fish
- `w_mat` = 10 g: Typical myctophid maturity
- `w_inf` = 50 g: Maximum for common species

**On-shelf fish** (multi-species aggregate):

- `w_min` = 10 g: Average recruitment size
- `w_mat` = 200 g: Multi-species average
- `w_inf` = 1,000 g: Representative maximum

### Euphausiids

**Antarctic Krill** (*Euphausia superba*):

Based on @siegel2005, @rosenberg1986, and @candy2006:

- `w_min` = 0.1 g: ~15 mm total length (recruitment to adult population)
- `w_mat` = 0.5 g: ~35 mm, sexually mature
- `w_inf` = 1.0 g: ~60 mm, maximum adult size

The EwE model represented krill as two stanzas (Small <24 months, Large ≥24 months). In mizer, these are combined into a single size-structured species spanning the full size range.

**Other Euphausiids**:

- `w_min` = 0.1 g
- `w_mat` = 0.4 g
- `w_inf` = 0.8 g (slightly smaller than *E. superba*)

### Marine Mammals and Seabirds: Adult-Only Representation

For marine mammals and seabirds, an **adult-only representation** was adopted because:

1. Juvenile marine mammals and seabirds have minimal marine predation (terrestrial/ice-based predators dominate)
2. Chick-rearing seabirds provision offspring rather than size-dependent foraging
3. EwE also represents these groups as adult biomass pools
4. Lack of detailed growth curves for Antarctic populations

Size ranges were set narrowly around adult body masses:

- `w_min` ≈ 80% of `w_mat`
- `w_inf` ≈ 120-400% of `w_mat` (accounting for sexual dimorphism where relevant)

**Seals and Killer Whale**:

| Species | w_min (g) | w_mat (g) | w_inf (g) | Notes |
|---------|------------|------------|------------|------------------------------|
| Killer Whale | 4,000,000 | 5,000,000 | 8,000,000 | Sexual dimorphism; males larger |
| Leopard Seal | 250,000 | 300,000 | 600,000 | Females larger than males |
| Weddell Seal | 350,000 | 400,000 | 600,000 | Both sexes similar |
| Crabeater Seal | 180,000 | 225,000 | 300,000 | Most abundant seal |
| Antarctic Fur Seal | 40,000 | 50,000 | 200,000 | Extreme sexual dimorphism |
| S. Elephant Seal | 600,000 | 800,000 | 4,000,000 | Extreme sexual dimorphism |

**Baleen and Sperm Whales**:

| Species | w_min (g) | w_mat (g) | w_inf (g) | Notes |
|---------|------------|------------|------------|------------------------------|
| Sperm Whale | 15,000,000 | 20,000,000 | 50,000,000 | Males much larger |
| Blue Whale | 80,000,000 | 100,000,000 | 150,000,000 | Largest animal |
| Fin Whale | 40,000,000 | 50,000,000 | 80,000,000 | Second largest |
| Minke Whale | 5,000,000 | 7,000,000 | 10,000,000 | Smallest baleen whale |
| Humpback Whale | 25,000,000 | 30,000,000 | 40,000,000 | Medium-sized |

**Penguins**:

| Species | w_min (g) | w_mat (g) | w_inf (g) | Notes |
|---------|------------|------------|------------|------------------------------|
| Emperor Penguin | 25,000 | 30,000 | 45,000 | Largest penguin |
| Gentoo Penguin | 5,000 | 6,000 | 8,000 | Increasing population |
| Chinstrap Penguin | 3,500 | 4,000 | 6,000 | Declining population |
| Adélie Penguin | 3,500 | 4,000 | 6,000 | Ice-associated |
| Macaroni Penguin | 4,000 | 5,000 | 6,000 | Crested penguin |

**Other consumers**:

| Species | w_min (g) | w_mat (g) | w_inf (g) | Notes |
|---------|-----------|-----------|-----------|------------------------------|
| Flying Birds | 500 | 2,000 | 5,000 | Multi-species average |
| Salps | 1 | 10 | 100 | Colonial tunicates |

## 2. Growth Parameters

### von Bertalanffy K Parameter

The von Bertalanffy growth coefficient ($K$, year$^{-1}$) describes the rate at which organisms approach their asymptotic size.

**Fish**: Literature values where available [@kock1992]:

| Species | K (year$^{-1}$) | Source/Notes |
|---------|-----------------|------------------------------|
| *N. rossii* | 0.13 | Slow-growing nototheniid |
| *C. gunnari* | 0.35 | Relatively fast for notothenioid |
| *G. gibberifrons* | 0.25 | Moderate growth rate |
| Myctophids | 0.40 | Typical for mesopelagic fish |
| On-shelf fish | 0.30 | Multi-species average |
| Cephalopods | 0.80 | Fast-growing, short-lived |

**Antarctic Krill**: K = 0.44 year$^{-1}$ [@rosenberg1986]

This value was used in the EwE multi-stanza model and is well-supported by field studies.

**Other Euphausiids**: K = 0.45 year$^{-1}$ (similar to Antarctic krill)

**Marine Mammals and Seabirds**: K = 2.0 year$^{-1}$ (High artificial value)

For adult-only representations, a high K value (2.0) is used to keep individuals within the narrow adult size range. This effectively represents rapid "growth" to adult size (recruitment of adults) with minimal time spent in non-adult size classes.

**Salps**: K = 1.5 year$^{-1}$ (moderate for size-structured representation)

### Maximum Consumption Rate (h)

The parameter `h` determines the maximum mass-specific consumption rate. In mizer, consumption scales as:

$$C = h \cdot M^n$$

where $M$ is body mass and $n$ is the allometric exponent (typically -0.25).

We calibrated `h` to match EwE Q/B ratios (consumption/biomass, year$^{-1}$):

For a species at size $w_{mat}$:
$$\frac{Q}{B} = h \cdot w_{mat}^{n-1}$$

Solving for $h$:
$$h = \frac{Q/B}{w_{mat}^{n-1}}$$

Using $n = -0.25$ (mizer default):
$$h = Q/B \cdot w_{mat}^{1.25}$$

This approach ensures that consumption rates at the characteristic adult size match the EwE model.

**Example calculations**:

| Species | Q/B (year$^{-1}$) | w_mat (g) | h |
|---------|-------------------|-----------|---|
| Antarctic Krill | 4.42 | 0.5 | 2.63 |
| *C. gunnari* | 4.62 | 300 | 1,531 |
| Crabeater Seal | 5.95 | 225,000 | 2.13 × 10$^6$ |
| Chinstrap Penguin | 15.28 | 4,000 | 4.87 × 10$^5$ |

The large variation in `h` values reflects the mass-scaling: larger animals need larger `h` to achieve similar mass-specific consumption rates.

### Standard Metabolism (ks)

In mizer, `ks` represents the coefficient for standard metabolism. Following standard mizer practice:

$$k_s = h$$

This assumes maximum consumption can sustain maximum metabolism, a reasonable approximation for active marine predators.

## 3. Mortality Parameters

### Background Mortality (z0)

Background mortality (`z0`) represents size-independent natural mortality not caused by predation within the model. This includes senescence, disease, emigration from the system, and mortality from predators not explicitly modeled.

**Derivation from EwE P/B ratio**:

For multi-cellular organisms, the production/biomass ratio approximately equals natural mortality [@blanchard2017]:

$$P/B \approx M$$

where $M$ is total natural mortality. In mizer, total mortality includes both predation mortality (emergent from size-based predation) and background mortality (`z0`).

As a starting point, we set:
$$z_0 = P/B$$

This provides a conservative estimate that will be adjusted during calibration when predation mortality is resolved. These values are initial estimates that will be tuned during model calibration to match observed biomass and population dynamics.

**EwE P/B values and derived z0**:

| Category | Species Example | P/B (year$^{-1}$) | z0 (year$^{-1}$) |
|----------|-----------------|-------------------|------------------|
| Krill | Antarctic Krill | 0.80 | 0.80 |
| Fish | *C. gunnari* | 0.48 | 0.48 |
| Fish | *N. rossii* | 0.29 | 0.29 |
| Seals | Crabeater Seal | 0.10 | 0.10 |
| Penguins | Chinstrap Penguin | 0.22 | 0.22 |
| Whales | Humpback Whale | 0.04 | 0.04 |

Higher mortality rates for smaller-bodied, shorter-lived species (krill, fish) and lower rates for long-lived marine mammals reflect expected life-history patterns.

## 4. Feeding Parameters

### Predator-Prey Mass Ratio (beta)

The parameter `beta` (β) represents the **preferred predator-prey mass ratio** (PPMR). A predator of mass $M_p$ preferentially feeds on prey of mass:

$$M_{prey} = \frac{M_p}{\beta}$$

**Derivation approach**:

Beta was estimated based on feeding mode (filter feeders, piscivores, specialists), typical prey sizes from EwE diet matrix, and literature values for similar species.

**Feeding mode categories**:

| Feeding Mode | Beta Range | Species Examples |
|--------------|------------|------------------|
| Filter feeders (phytoplankton) | 5-10 | Krill, salps |
| Filter feeders (zooplankton) | 10-50 | Baleen whales (krill specialists) |
| Benthic invertivores | 50-100 | *G. gibberifrons*, some seals |
| Generalist fish feeders | 100-300 | Most fish, penguins, seals |
| Piscivores | 200-500 | Large fish, seals |
| Large prey specialists | 500-1000 | Killer whale, sperm whale, leopard seal |

**Species-specific beta values**:

| Species | Beta | Rationale |
|---------|------|-----------|
| Antarctic Krill | 10 | Filter feeder on phytoplankton and ice algae |
| Crabeater Seal | 200 | Krill specialist; adult krill ~1g, seal ~225kg |
| Chinstrap Penguin | 100 | Krill specialist; smaller PPMR than seals |
| Blue Whale | 200 | Krill specialist filter feeder |
| Leopard Seal | 500 | Large prey (seals, penguins, krill) |
| Killer Whale | 1000 | Apex predator, largest prey |
| *G. gibberifrons* | 50 | Benthic invertebrate feeder |

### Feeding Kernel Width (sigma)

The parameter `sigma` (σ) determines the **width of the feeding kernel** on a log-scale. Smaller σ indicates more selective feeding (narrow prey size range), while larger σ indicates generalist feeding.

The feeding kernel follows a log-normal distribution:
$$\phi(w, w_p) \propto \exp\left(-\frac{[\ln(w/w_p) + \ln(\beta)]^2}{2\sigma^2}\right)$$

**Selectivity categories**:

| Selectivity | Sigma | Species Type |
|-------------|-------|--------------|
| Highly selective specialists | 0.8-1.0 | Krill-specialist baleen whales, filter feeders |
| Moderate selectivity | 1.0-1.5 | Most fish, seals, penguins |
| Generalist feeders | 1.5-2.0 | Benthic feeders, opportunistic predators |

**Species-specific sigma values**:

| Species | Sigma | Diet Characteristics |
|---------|-------|---------------------|
| Blue Whale | 0.8 | 61% krill + 39% other euphausiids (narrow diet) |
| Chinstrap Penguin | 0.8 | 95% krill (very narrow diet) |
| Crabeater Seal | 1.0 | 78% krill (specialist) |
| Antarctic Krill | 2.0 | Feeds on range of phytoplankton sizes |
| *G. gibberifrons* | 2.0 | Benthic invertebrates of various sizes |
| Leopard Seal | 1.2 | Diverse diet (krill, fish, seals, penguins) |

## 5. Interaction Matrix

The **interaction matrix** defines species-specific feeding preferences beyond size-based selection. Element $\theta_{ij}$ represents the preference of predator $j$ for prey $i$, independent of size.

**Derivation from EwE diet matrix**:

The EwE diet matrix provides the proportion of each prey in each predator's diet. This was translated to mizer's interaction matrix as follows:

1. **Direct mapping**: For species-to-species interactions, EwE diet proportions were used directly as interaction matrix elements
2. **Krill combination**: Antarctic Krill in mizer represents both EwE krill stanzas (Large + Small). Interaction values were summed:
   $$\theta_{krill,predator} = \theta_{krill\_large,predator} + \theta_{krill\_small,predator}$$
3. **Resource interactions**: Interactions with plankton groups (phytoplankton, zooplankton, ice algae, benthos) are specified in [Step 4](04_resource_spectrum.qmd)

**Key trophic interactions preserved**:

| Predator | Primary Prey | Interaction Strength | EwE Diet % |
|----------|--------------|---------------------|------------|
| Chinstrap Penguin | Antarctic Krill | 0.95 | 95% |
| Adélie Penguin | Antarctic Krill | 0.96 | 96% |
| Crabeater Seal | Antarctic Krill | 0.78 | 78% |
| Humpback Whale | Antarctic Krill | 0.76 | 76% |
| Leopard Seal | Antarctic Krill | 0.70 | 70% |
| Leopard Seal | Seals & Penguins | 0.11 | 11% combined |
| Killer Whale | Seals | 0.87 | 87% |
| *G. gibberifrons* | Benthos | 0.59 | 59% |

The interaction matrix preserves the **krill-centric nature** of the WAP ecosystem, with 20+ species consuming krill.

## 6. Reproductive Parameters

### Reproductive Efficiency (erepro)

The parameter `erepro` represents the proportion of consumed energy allocated to reproduction. These values are initial estimates that will be tuned during model calibration to match observed biomass and population dynamics.

**Category-based assignments**:

| Category | erepro | Rationale |
|----------|--------|-----------|
| Fish | 0.10 | ~10% energy to reproduction, typical for fish |
| Krill | 0.30 | High reproductive output, batch spawning |
| Marine mammals | 0.01 | Low reproductive rate, K-selected |
| Penguins & birds | 0.05 | Intermediate, annual breeding |
| Salps | 0.20 | High reproduction, r-selected |

### Maximum Recruitment (R_max)

The parameter `R_max` represents maximum recruitment and can be set explicitly based on observations, calculated from steady-state conditions, or calibrated to match biomass targets. For this initial parameterization, `R_max` is left as `NA` and will be calculated during steady-state initialization ([Step 6](06_initial_setup.qmd)).

# Parameter Assessment

## Species Parameters Summary

```{r}
#| label: load-data
#| code-summary: "Load species parameters and interaction matrices"

# Load species parameters
species_params <- read_csv(file.path(MODEL_DIR, "species_parameters.csv"),
                           show_col_types = FALSE)

# Load interaction matrices
interaction_matrix <- read_csv(file.path(MODEL_DIR, "interaction_matrix.csv"),
                               show_col_types = FALSE)

interaction_long <- read_csv(file.path(MODEL_DIR, "interaction_matrix_long.csv"),
                             show_col_types = FALSE)
```

```{r}
#| label: tbl-data-summary
#| tbl-cap: "Species counts by functional category"
#| code-summary: "Summarize species counts"

# Summary table by category
species_params %>%
  group_by(category) %>%
  summarise(
    n_species = n(),
    n_monitored = sum(monitored),
    .groups = "drop"
  ) %>%
  kable()
```

The complete species parameter data frame includes 26 species with species name, taxonomic/functional category, monitored status, size parameters (w_min, w_mat, w_inf), growth parameters (k_vb, h, ks), mortality (z0), feeding parameters (beta, sigma, erepro), and original EwE values for reference.

## Size Parameters

```{r}
#| label: fig-body-size-distribution
#| fig-cap: "Species body size ranges and distribution of size parameters"
#| fig-width: 10
#| fig-height: 8
#| code-summary: "Plot body size distributions"

# Create a long format for plotting size parameters
size_long <- species_params %>%
  select(species, category, w_min, w_mat, w_inf) %>%
  pivot_longer(cols = c(w_min, w_mat, w_inf),
               names_to = "size_type",
               values_to = "mass_g") %>%
  mutate(size_type = factor(size_type, 
                             levels = c("w_min", "w_mat", "w_inf"),
                             labels = c("Minimum", "Maturity", "Maximum")))

# Plot body size ranges on log scale
p1 <- ggplot(species_params, aes(y = reorder(species, w_mat))) +
  geom_segment(aes(x = w_min, xend = w_inf, yend = species, color = category),
               linewidth = 2, alpha = 0.7) +
  geom_point(aes(x = w_mat, color = category), size = 3, shape = 18) +
  scale_x_log10(labels = scales::comma) +
  scale_color_manual(values = category_colors) +
  labs(x = "Body mass (g, log scale)", y = NULL,
       title = "Species body size ranges",
       subtitle = "Lines show min to max, diamonds show maturity size") +
  theme(legend.position = "right")

# Distribution by category
p2 <- ggplot(size_long, aes(x = mass_g, fill = category)) +
  geom_histogram(bins = 30, alpha = 0.7) +
  scale_x_log10(labels = scales::comma) +
  scale_fill_manual(values = category_colors) +
  facet_wrap(~size_type, ncol = 1) +
  labs(x = "Body mass (g, log scale)", y = "Count",
       title = "Distribution of size parameters")

p1 / p2 + plot_layout(heights = c(2, 1))
```

As shown in @fig-body-size-distribution, marine mammals, whales, and penguins show narrow size ranges (ratio < 5), consistent with adult-only representation, while fish, cephalopods, and krill show wider size ranges (ratio > 5), representing full size structure from recruitment to maximum.

```{r}
#| label: fig-size-ratios
#| fig-cap: "Size ratios by category showing maturity relative to minimum size, maximum relative to maturity, and total size range"
#| fig-width: 10
#| fig-height: 5
#| code-summary: "Calculate and plot size ratios"

# Calculate size ratios
species_params <- species_params %>%
  mutate(
    mat_min_ratio = w_mat / w_min,
    max_mat_ratio = w_inf / w_mat,
    size_range = w_inf / w_min
  )

# Plot ratios by category
p1 <- ggplot(species_params, aes(x = category, y = mat_min_ratio, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_y_log10() +
  scale_fill_manual(values = category_colors) +
  labs(y = "w_mat / w_min (log scale)", x = NULL,
       title = "Maturity relative to minimum size") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

p2 <- ggplot(species_params, aes(x = category, y = max_mat_ratio, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_y_log10() +
  scale_fill_manual(values = category_colors) +
  labs(y = "w_inf / w_mat (log scale)", x = NULL,
       title = "Maximum relative to maturity size") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

p3 <- ggplot(species_params, aes(x = category, y = size_range, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_y_log10() +
  scale_fill_manual(values = category_colors) +
  labs(y = "w_inf / w_min (log scale)", x = NULL,
       title = "Total size range") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

p1 + p2 + p3
```

The size range ratios shown in @fig-size-ratios align with the conceptual model design from [Step 2](02_model_structure.qmd).

## Growth Parameters

```{r}
#| label: fig-k-parameter
#| fig-cap: "Von Bertalanffy growth coefficient by category and relationship with body size"
#| fig-width: 10
#| fig-height: 6
#| code-summary: "Plot K parameter distributions and relationships"

# Plot K by category and body size
p1 <- ggplot(species_params, aes(x = category, y = k_vb, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_fill_manual(values = category_colors) +
  labs(y = "von Bertalanffy K (year⁻¹)", x = NULL,
       title = "Growth rate by functional category") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

# K vs body size relationship
p2 <- ggplot(species_params, aes(x = w_inf, y = k_vb, color = category)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel(aes(label = species), size = 2.5, max.overlaps = 15) +
  scale_x_log10(labels = scales::comma) +
  scale_color_manual(values = category_colors) +
  labs(x = "Maximum body mass (g, log scale)", 
       y = "von Bertalanffy K (year⁻¹)",
       title = "Growth rate vs. body size",
       subtitle = "Expected inverse relationship for fish/krill; high K for adult-only groups") +
  theme(legend.position = "bottom")

p1 / p2
```

@fig-k-parameter shows the expected inverse relationship between growth rate and body size for fish and krill, while adult-only groups (mammals, birds) have artificially high K values to maintain narrow size distributions.

```{r}
#| label: fig-consumption-rate
#| fig-cap: "Maximum consumption coefficient and calibration to EwE Q/B ratios"
#| fig-width: 10
#| fig-height: 6
#| code-summary: "Plot consumption parameters and Q/B calibration"

# Plot h vs body size
p1 <- ggplot(species_params, aes(x = w_mat, y = h, color = category)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel(aes(label = species), size = 2.5, max.overlaps = 15) +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  scale_color_manual(values = category_colors) +
  labs(x = "Maturity mass (g, log scale)", 
       y = "Maximum consumption coefficient h (log scale)",
       title = "Consumption coefficient vs. body size",
       subtitle = "h scales with body mass to maintain mass-specific consumption rates") +
  theme(legend.position = "bottom")

# Calculate mass-specific consumption at maturity (Q/B equivalent)
species_params <- species_params %>%
  mutate(qb_derived = h * w_mat^(-0.25))

p2 <- ggplot(species_params, aes(x = ewe_qb, y = qb_derived, color = category)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text_repel(aes(label = species), size = 2.5, max.overlaps = 10) +
  scale_color_manual(values = category_colors) +
  labs(x = "EwE Q/B (year⁻¹)", 
       y = "Derived Q/B from mizer h (year⁻¹)",
       title = "Comparison of consumption rates",
       subtitle = "Points should fall on 1:1 line if h is correctly calibrated") +
  theme(legend.position = "bottom")

p1 / p2
```

@fig-consumption-rate demonstrates successful calibration of the h parameter to EwE consumption rates, with most species falling close to the 1:1 line.

## Mortality Parameters

```{r}
#| label: fig-mortality-parameters
#| fig-cap: "Background mortality by category, relationship with body size, and derivation from EwE P/B ratios"
#| fig-width: 10
#| fig-height: 8
#| code-summary: "Plot mortality parameters and relationships"

# Plot z0 by category
p1 <- ggplot(species_params, aes(x = category, y = z0, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_y_log10() +
  scale_fill_manual(values = category_colors) +
  labs(y = "Background mortality z0 (year⁻¹, log scale)", x = NULL,
       title = "Background mortality by functional category") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

# Mortality vs body size (expected inverse relationship)
p2 <- ggplot(species_params, aes(x = w_mat, y = z0, color = category)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "black", linetype = "dashed") +
  geom_text_repel(aes(label = species), size = 2.5, max.overlaps = 15) +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10() +
  scale_color_manual(values = category_colors) +
  labs(x = "Maturity mass (g, log scale)", 
       y = "Background mortality z0 (year⁻¹, log scale)",
       title = "Mortality vs. body size",
       subtitle = "Expected negative relationship: larger animals have lower mortality") +
  theme(legend.position = "bottom")

# Compare z0 to EwE P/B
p3 <- ggplot(species_params, aes(x = ewe_pb, y = z0, color = category)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text_repel(aes(label = species), size = 2.5, max.overlaps = 10) +
  scale_color_manual(values = category_colors) +
  labs(x = "EwE P/B (year⁻¹)", 
       y = "Background mortality z0 (year⁻¹)",
       title = "z0 derived from EwE P/B",
       subtitle = "z0 = P/B as starting estimate") +
  theme(legend.position = "bottom")

(p1 + p2) / p3
```

@fig-mortality-parameters shows the clear negative relationship between body size and mortality, with mortality rates derived directly from EwE P/B ratios.

## Feeding Parameters

```{r}
#| label: fig-beta-parameters
#| fig-cap: "Predator-prey mass ratio (PPMR) distribution by category and relationship with body size"
#| fig-width: 10
#| fig-height: 6
#| code-summary: "Plot beta (PPMR) parameters"

# Plot beta by category
p1 <- ggplot(species_params, aes(x = category, y = beta, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_y_log10() +
  scale_fill_manual(values = category_colors) +
  labs(y = "PPMR beta (log scale)", x = NULL,
       title = "Predator-prey mass ratio by category") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

# Beta vs body size
p2 <- ggplot(species_params, aes(x = w_mat, y = beta, color = category)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel(aes(label = species), size = 2.5, max.overlaps = 15) +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10() +
  scale_color_manual(values = category_colors) +
  labs(x = "Maturity mass (g, log scale)", 
       y = "PPMR beta (log scale)",
       title = "Feeding mode vs. body size",
       subtitle = "Higher beta = larger prey relative to predator size") +
  theme(legend.position = "bottom")

p1 + p2
```

@fig-beta-parameters illustrates the range of feeding strategies from filter feeders (low beta) to apex predators (high beta).

```{r}
#| label: fig-sigma-parameters
#| fig-cap: "Feeding kernel width (selectivity) by category and relationship with PPMR"
#| fig-width: 10
#| fig-height: 5
#| code-summary: "Plot sigma (selectivity) parameters"

# Plot sigma by category
p1 <- ggplot(species_params, aes(x = category, y = sigma, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_fill_manual(values = category_colors) +
  labs(y = "Feeding kernel width σ", x = NULL,
       title = "Diet selectivity by category",
       subtitle = "Lower σ = more selective feeding") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

# Beta vs sigma (feeding strategy)
p2 <- ggplot(species_params, aes(x = beta, y = sigma, color = category)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel(aes(label = species), size = 2.5, max.overlaps = 15) +
  scale_x_log10() +
  scale_color_manual(values = category_colors) +
  labs(x = "PPMR beta (log scale)", 
       y = "Feeding kernel width σ",
       title = "Feeding strategy space",
       subtitle = "Relationship between prey size preference and selectivity") +
  theme(legend.position = "bottom")

p1 + p2
```

@fig-sigma-parameters shows the feeding selectivity patterns, with specialists having lower sigma values than generalists.

## Interaction Matrix Analysis

```{r}
#| label: network-prep
#| code-summary: "Calculate network statistics"

# Calculate network statistics
network_stats <- interaction_long %>%
  filter(interaction > 0) %>%
  group_by(predator) %>%
  summarise(
    n_prey = n(),
    mean_interaction = mean(interaction),
    max_interaction = max(interaction),
    .groups = "drop"
  ) %>%
  left_join(species_params %>% select(species, category), 
            by = c("predator" = "species"))

# Prey importance
prey_stats <- interaction_long %>%
  filter(interaction > 0) %>%
  group_by(prey) %>%
  summarise(
    n_predators = n(),
    mean_interaction = mean(interaction),
    total_predation = sum(interaction),
    .groups = "drop"
  ) %>%
  left_join(species_params %>% select(species, category), 
            by = c("prey" = "species"))
```

```{r}
#| label: fig-diet-breadth
#| fig-cap: "Diet breadth by functional category and predation pressure by prey species"
#| fig-width: 10
#| fig-height: 8
#| code-summary: "Plot diet breadth and predation pressure"

# Plot diet breadth by category
p1 <- ggplot(network_stats, aes(x = category, y = n_prey, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_fill_manual(values = category_colors) +
  labs(y = "Number of prey species", x = NULL,
       title = "Diet breadth by functional category",
       subtitle = "Number of species consumed by each predator") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

# Predator diversity by prey
p2 <- ggplot(prey_stats, aes(x = reorder(prey, n_predators), y = n_predators, fill = category)) +
  geom_col(alpha = 0.7) +
  scale_fill_manual(values = category_colors) +
  coord_flip() +
  labs(y = "Number of predator species", x = NULL,
       title = "Predation pressure",
       subtitle = "Number of predators consuming each prey species")

p1 / p2 + plot_layout(heights = c(1, 2))
```

@fig-diet-breadth shows Antarctic Krill has the highest predation pressure, confirming its keystone role in the ecosystem.

```{r}
#| label: fig-interaction-heatmap
#| fig-cap: "Species interaction matrix heatmap showing feeding relationships"
#| fig-width: 12
#| fig-height: 10
#| code-summary: "Create interaction matrix heatmap"

# Create heatmap of interactions
species_order <- species_params %>%
  arrange(category, desc(w_mat)) %>%
  pull(species)

interaction_matrix_ordered <- interaction_matrix %>%
  mutate(prey = factor(prey, levels = species_order)) %>%
  pivot_longer(-prey, names_to = "predator", values_to = "interaction") %>%
  mutate(predator = factor(predator, levels = species_order))

ggplot(interaction_matrix_ordered, aes(x = predator, y = prey, fill = interaction)) +
  geom_tile() +
  scale_fill_viridis(option = "magma", trans = "sqrt", direction = -1,
                     breaks = c(0, 0.01, 0.1, 0.5, 0.9),
                     labels = c("0", "0.01", "0.1", "0.5", "0.9")) +
  labs(x = "Predator", y = "Prey",
       title = "Species interaction matrix",
       subtitle = "Color intensity shows interaction strength (square-root scale)",
       fill = "Interaction\nstrength") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 8),
        axis.text.y = element_text(size = 8))
```

@fig-interaction-heatmap provides a visual representation of the complete feeding network, with darker colors indicating stronger trophic interactions.

```{r}
#| label: fig-krill-interactions
#| fig-cap: "Antarctic Krill in predator diets and relationship with predator size"
#| fig-width: 10
#| fig-height: 6
#| code-summary: "Analyze and plot krill interactions"

# Extract krill interactions
krill_predators <- interaction_long %>%
  filter(prey == "Antarctic Krill", interaction > 0) %>%
  left_join(species_params %>% select(species, category, w_mat), 
            by = c("predator" = "species")) %>%
  arrange(desc(interaction))

# Plot krill consumption by predator category
p1 <- ggplot(krill_predators, aes(x = reorder(predator, interaction), 
                                    y = interaction, fill = category)) +
  geom_col(alpha = 0.7) +
  scale_fill_manual(values = category_colors) +
  coord_flip() +
  labs(y = "Proportion of diet", x = NULL,
       title = "Antarctic Krill in predator diets",
       subtitle = "Higher values indicate greater krill specialization")

# Krill interaction vs predator size
p2 <- ggplot(krill_predators, aes(x = w_mat, y = interaction, color = category)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel(aes(label = predator), size = 2.5, max.overlaps = 15) +
  scale_x_log10(labels = scales::comma) +
  scale_color_manual(values = category_colors) +
  labs(x = "Predator maturity mass (g, log scale)", 
       y = "Proportion of diet from krill",
       title = "Krill dependence vs. predator size")

p1 + p2
```

@fig-krill-interactions emphasizes the central role of Antarctic Krill, with 20+ species showing dietary dependence ranging from moderate to extreme specialization.

# Biological and Ecological Reasonableness

## Biological Reasonableness Assessment

All parameters are biologically reasonable:

1. **Size parameters** appropriately represent either full size structure (fish, krill) or adult-only (mammals, birds)
2. **Growth parameters** match published literature for Antarctic species where available
3. **Mortality rates** follow expected size-scaling relationships and life history patterns
4. **Consumption rates** successfully calibrated to match EwE Q/B ratios
5. **Feeding parameters** (beta, sigma) align with known feeding modes and prey preferences

## Ecological Reasonableness Assessment

The interaction matrix represents a realistic Antarctic food web:

1. **Krill-centric structure** preserved with 20+ krill consumers
2. **Trophic hierarchy** clear from krill → fish → seals/penguins → killer whale
3. **Diet specialization** ranges from narrow (>95% krill) to broad generalists
4. **Apex predators** correctly identified (killer whale, flying birds)
5. **No inappropriate interactions** (cannibalism, size violations)
6. **Connectance** (~10%) typical for marine ecosystems

## Key Assumptions and Limitations

### Adult-Only Representation

**Assumption**: Marine mammals and seabirds can be represented as adult-only size classes with high K to maintain narrow size distribution.

**Justification**: Juveniles have minimal marine predation, chick provisioning by parents decouples juveniles from size-based feeding, EwE also uses adult biomass pools, and simplifies parameterization where growth data are lacking.

**Limitations**: Cannot represent juvenile dynamics, misses ontogenetic diet shifts, and population structure simplified.

### Combined Krill Stanzas

**Assumption**: EwE's two krill stanzas can be combined into single size-structured species.

**Justification**: Mizer naturally represents size structure, growth parameter (K = 0.44) describes transition from small to large, and simplifies model while preserving size-dependent dynamics.

**Limitations**: Loses explicit age-based mortality differences between stanzas, and recruitment patterns may need careful calibration.

### P/B as Background Mortality

**Assumption**: EwE P/B ratio provides reasonable starting point for background mortality `z0`.

**Justification**: P/B ≈ M for multi-cellular organisms, conservative estimate (total mortality ≥ background mortality), and will be refined during calibration.

**Limitations**: May overestimate z0 if predation mortality is high, and needs calibration once predation is resolved in model.

# Files Generated

The parameter derivation script [`01_derive_species_parameters.R`](../Models/AI-assisted/Attempt 1/01_derive_species_parameters.R) generates:

1. **`species_parameters.csv`**: Complete species parameter data frame (26 species × 23 columns)
2. **`interaction_matrix.csv`**: Species-species interaction matrix (26 × 26, wide format)
3. **`interaction_matrix_long.csv`**: Interaction matrix in long format for analysis

# References

::: {#refs}
:::

---

[Next: Resource Spectrum Parameterization →](04_resource_spectrum.qmd)
